                    # Ensure devices is a list
                    if devices is None:
                        devices = []
                    elif not isinstance(devices, list):
                        devices = list(devices) if hasattr(devices, '__iter__') else []
                    
                    # Check if devices list is empty
                    if len(devices) == 0:
                        raise Exception("No trusted devices found. Please set up trusted devices in your Apple ID settings or use a different authentication method.")
                    
                    logger.info("Available trusted devices:")
                    for i, device in enumerate(devices):
                        device_name = device.get('deviceName', 'Unknown')
                        device_type = device.get('deviceType', 'Unknown')
                        logger.info(f"  {i}: {device_name} ({device_type})")
                    
                    # Get and validate device selection
                    while True:
                        device_index = input(f"Select device (enter number 0-{len(devices)-1}): ").strip()
                        try:
                            idx = int(device_index)
                            if 0 <= idx < len(devices):
                                device = devices[idx]
                                break
                            else:
                                logger.warning(f"Invalid selection. Please enter a number between 0 and {len(devices)-1}")
                        except ValueError:
                            logger.warning("Invalid input. Please enter a number.")
                    
                    device_name = device.get('deviceName', 'Unknown')
                    
                    if not self.api.send_verification_code(device):
                        raise Exception("Failed to send verification code")
                    logger.info(f"Verification code sent to {device_name}")
                
                # Allow retries for 2FA code
                max_attempts = 3
                for attempt in range(max_attempts):
                    code = input(f"Enter 2FA code (attempt {attempt + 1}/{max_attempts}): ").strip()
                    # Remove any spaces or dashes from the code
                    code = code.replace(' ', '').replace('-', '')
                    
                    if self.api.validate_verification_code(device, code):
                        logger.info("âœ“ Verification code accepted")
                        break
                    else:
                        if attempt < max_attempts - 1:
                            logger.warning("Invalid verification code. Please try again.")
                            logger.info("Note: Codes expire quickly. You may need to request a new code.")
                            retry = input("Request new code? (y/n): ").strip().lower()
                            if retry == 'y':
                                if not self.api.send_verification_code(device):
                                    raise Exception("Failed to send new verification code")
                                logger.info("New verification code sent")
                        else:
                            raise Exception("Invalid verification code after multiple attempts")
            
            logger.info("Successfully authenticated with iCloud")
            
        except PyiCloudFailedLoginException as e:
            raise Exception(f"Failed to login to iCloud: {e}")
        except Exception as e:
            raise Exception(f"Authentication error: {e}")
    
    def create_album(self, album_name: str) -> bool:
        """
        Create an album in iCloud Photos.
        
        Note: pyicloud may not support album creation directly.
        This is a placeholder for future implementation.
        
        Args:
            album_name: Name of the album to create
        
        Returns:
            True if successful, False otherwise
        """
        try:
            # pyicloud doesn't have direct album creation support
            # Albums may need to be created manually or through Photos app
