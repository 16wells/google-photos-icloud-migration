"""
Upload media files to iCloud Photos using pyicloud library.
"""
import logging
import time
from pathlib import Path
from typing import List, Dict, Optional, Callable
from pyicloud import PyiCloudService
from pyicloud.exceptions import PyiCloudFailedLoginException, PyiCloud2SARequiredException
from tqdm import tqdm

logger = logging.getLogger(__name__)


class iCloudUploader:
    """Handles uploading media files to iCloud Photos."""
    
    def __init__(self, apple_id: str, password: str, 
                 trusted_device_id: Optional[str] = None):
        """
        Initialize the iCloud uploader.
        
        Args:
            apple_id: Apple ID email
            password: Apple ID password (empty string will prompt)
            trusted_device_id: Optional trusted device ID for 2FA
        """
        self.apple_id = apple_id
        self.password = password.strip() if password else ''
        self.trusted_device_id = trusted_device_id
        self.api = None
        
        # Prompt for password if empty
        if not self.password:
            import getpass
            logger.info("iCloud password not provided. Please enter your Apple ID password:")
            logger.info("(Note: If you have 2FA enabled, use your regular password)")
            self.password = getpass.getpass("Password: ")
        
        self._authenticate()
    
    def _authenticate(self):
        """Authenticate with iCloud."""
        try:
            self.api = PyiCloudService(self.apple_id, self.password)
            
            # Handle 2FA if required
            if self.api.requires_2fa:
                logger.info("Two-factor authentication required")
                
                if self.trusted_device_id:
                    # Use trusted device
                    devices = self.api.trusted_devices
                    
                    # Ensure devices is a list
                    if devices is None:
                        devices = []
                    elif not isinstance(devices, list):
                        devices = list(devices) if hasattr(devices, '__iter__') else []
                    
                    if len(devices) == 0:
                        raise Exception("No trusted devices found. Please set up trusted devices in your Apple ID settings.")
                    
                    try:
                        device_idx = int(self.trusted_device_id)
                        if device_idx < 0 or device_idx >= len(devices):
                            raise Exception(f"Invalid trusted_device_id: {self.trusted_device_id}. Valid range: 0-{len(devices)-1}")
                        device = devices[device_idx]
                    except ValueError:
                        raise Exception(f"Invalid trusted_device_id format: {self.trusted_device_id}. Must be a number.")
                    
                    device_name = device.get('deviceName', 'Unknown')
                    logger.info(f"Using trusted device: {device_name}")
                    if not self.api.send_verification_code(device):
                        raise Exception("Failed to send verification code")
                    logger.info(f"Verification code sent to {device_name}")
                else:
                    # List available devices
                    devices = self.api.trusted_devices
                    
