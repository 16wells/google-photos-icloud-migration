#!/usr/bin/env python3
"""
Update script for VM - Run this on your VM to update the files.
This script contains the complete updated file contents (base64 encoded).
"""

import base64
import sys
from pathlib import Path

# Base64 encoded drive_downloader.py
DRIVE_B64 = """IiIiCkdvb2dsZSBEcml2ZSBBUEkgaW50ZWdyYXRpb24gZm9yIGRvd25sb2FkaW5nIEdvb2dsZSBUYWtlb3V0IHppcCBmaWxlcy4KIiIiCmltcG9ydCBvcwppbXBvcnQganNvbgppbXBvcnQgc2h1dGlsCmZyb20gcGF0aGxpYiBpbXBvcnQgUGF0aApmcm9tIHR5cGluZyBpbXBvcnQgTGlzdCwgT3B0aW9uYWwKZnJvbSBnb29nbGVhcGljbGllbnQuZGlzY292ZXJ5IGltcG9ydCBidWlsZApmcm9tIGdvb2dsZWFwaWNsaWVudC5odHRwIGltcG9ydCBNZWRpYUlvQmFzZURvd25sb2FkCmZyb20gZ29vZ2xlLm9hdXRoMi5jcmVkZW50aWFscyBpbXBvcnQgQ3JlZGVudGlhbHMKZnJvbSBnb29nbGVfYXV0aF9vYXV0aGxpYi5mbG93IGltcG9ydCBJbnN0YWxsZWRBcHBGbG93CmZyb20gZ29vZ2xlLmF1dGgudHJhbnNwb3J0LnJlcXVlc3RzIGltcG9ydCBSZXF1ZXN0CmltcG9ydCBpbwppbXBvcnQgbG9nZ2luZwoKbG9nZ2VyID0gbG9nZ2luZy5nZXRMb2dnZXIoX19uYW1lX18pCgojIFNjb3BlcyByZXF1aXJlZCBmb3IgR29vZ2xlIERyaXZlIEFQSQpTQ09QRVMgPSBbJ2h0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL2F1dGgvZHJpdmUucmVhZG9ubHknXQoKCmNsYXNzIERyaXZlRG93bmxvYWRlcjoKICAgICIiIkhhbmRsZXMgZG93bmxvYWRpbmcgZmlsZXMgZnJvbSBHb29nbGUgRHJpdmUuIiIiCiAgICAKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjcmVkZW50aWFsc19maWxlOiBzdHIpOgogICAgICAgICIiIgogICAgICAgIEluaXRpYWxpemUgdGhlIERyaXZlIGRvd25sb2FkZXIuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgY3JlZGVudGlhbHNfZmlsZTogUGF0aCB0byBHb29nbGUgRHJpdmUgQVBJIGNyZWRlbnRpYWxzIEpTT04gZmlsZQogICAgICAgICIiIgogICAgICAgIHNlbGYuY3JlZGVudGlhbHNfZmlsZSA9IGNyZWRlbnRpYWxzX2ZpbGUKICAgICAgICBzZWxmLnNlcnZpY2UgPSBOb25lCiAgICAgICAgc2VsZi5fYXV0aGVudGljYXRlKCkKICAgIAogICAgZGVmIF9hdXRoZW50aWNhdGUoc2VsZik6CiAgICAgICAgIiIiQXV0aGVudGljYXRlIHdpdGggR29vZ2xlIERyaXZlIEFQSS4iIiIKICAgICAgICBjcmVkcyA9IE5vbmUKICAgICAgICB0b2tlbl9maWxlID0gJ3Rva2VuLmpzb24nCiAgICAgICAgCiAgICAgICAgIyBMb2FkIGV4aXN0aW5nIHRva2VuIGlmIGF2YWlsYWJsZQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKHRva2VuX2ZpbGUpOgogICAgICAgICAgICBjcmVkcyA9IENyZWRlbnRpYWxzLmZyb21fYXV0aG9yaXplZF91c2VyX2ZpbGUodG9rZW5fZmlsZSwgU0NPUEVTKQogICAgICAgIAogICAgICAgICMgSWYgdGhlcmUgYXJlIG5vICh2YWxpZCkgY3JlZGVudGlhbHMgYXZhaWxhYmxlLCBsZXQgdGhlIHVzZXIgbG9nIGluCiAgICAgICAgaWYgbm90IGNyZWRzIG9yIG5vdCBjcmVkcy52YWxpZDoKICAgICAgICAgICAgaWYgY3JlZHMgYW5kIGNyZWRzLmV4cGlyZWQgYW5kIGNyZWRzLnJlZnJlc2hfdG9rZW46CiAgICAgICAgICAgICAgICBjcmVkcy5yZWZyZXNoKFJlcXVlc3QoKSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGZsb3cgPSBJbnN0YWxsZWRBcHBGbG93LmZyb21fY2xpZW50X3NlY3JldHNfZmlsZSgKICAgICAgICAgICAgICAgICAgICBzZWxmLmNyZWRlbnRpYWxzX2ZpbGUsIFNDT1BFUykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBDaGVjayBpZiB3ZSdyZSBpbiBhIGhlYWRsZXNzIGVudmlyb25tZW50IChubyBESVNQTEFZKQogICAgICAgICAgICAgICAgIyBVc2UgbWFudWFsIGF1dGhvcml6YXRpb24gZm9yIGhlYWRsZXNzIGVudmlyb25tZW50cwogICAgICAgICAgICAgICAgaWYgb3MuZW52aXJvbi5nZXQoJ0RJU1BMQVknKSBpcyBOb25lIG9yIG5vdCBzZWxmLl9jYW5fb3Blbl9icm93c2VyKCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIj0iICogNjApCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlJ1bm5pbmcgaW4gaGVhZGxlc3MgbW9kZSAtIE1hbnVhbCBhdXRob3JpemF0aW9uIHJlcXVpcmVkIikKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiPSIgKiA2MCkKICAgICAgICAgICAgICAgICAgICAjIEZvciBEZXNrdG9wIGFwcHMsIHVzZSBsb2NhbGhvc3QgcmVkaXJlY3QgYnV0IGhhbmRsZSBtYW51YWxseQogICAgICAgICAgICAgICAgICAgICMgU2V0IHJlZGlyZWN0X3VyaSB0byBsb2NhbGhvc3QgKHdvcmtzIHdpdGggRGVza3RvcCBhcHAgT0F1dGggY2xpZW50cykKICAgICAgICAgICAgICAgICAgICBmbG93LnJlZGlyZWN0X3VyaSA9ICdodHRwOi8vbG9jYWxob3N0OjgwODAvJwogICAgICAgICAgICAgICAgICAgIGF1dGhfdXJsLCBfID0gZmxvdy5hdXRob3JpemF0aW9uX3VybChwcm9tcHQ9J2NvbnNlbnQnLCBhY2Nlc3NfdHlwZT0nb2ZmbGluZScpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIiIpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlBsZWFzZSB2aXNpdCB0aGlzIFVSTCB0byBhdXRob3JpemUgdGhlIGFwcGxpY2F0aW9uOiIpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIiIpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oYXV0aF91cmwpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIiIpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkFmdGVyIGF1dGhvcml6aW5nLCBHb29nbGUgd2lsbCB0cnkgdG8gcmVkaXJlY3QgdG8gbG9jYWxob3N0LiIpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlNpbmNlIGxvY2FsaG9zdCB3b24ndCB3b3JrLCBsb29rIGZvciB0aGUgJ2NvZGUnIHBhcmFtZXRlciBpbiB0aGUgVVJMLiIpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlRoZSBVUkwgd2lsbCBsb29rIGxpa2U6IGh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC8/Y29kZT1YWFhYWCZzY29wZT0uLi4iKQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCIiKQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJDb3B5IHRoZSBFTlRJUkUgcmVkaXJlY3QgVVJMIGFuZCBwYXN0ZSBpdCBoZXJlOiIpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIiIpCiAgICAgICAgICAgICAgICAgICAgYXV0aG9yaXphdGlvbl9yZXNwb25zZSA9IGlucHV0KCJFbnRlciB0aGUgYXV0aG9yaXphdGlvbiByZXNwb25zZSBVUkw6ICIpLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICAjIEV4dHJhY3QgY29kZSBmcm9tIFVSTAogICAgICAgICAgICAgICAgICAgIGZyb20gdXJsbGliLnBhcnNlIGltcG9ydCB1cmxwYXJzZSwgcGFyc2VfcXMKICAgICAgICAgICAgICAgICAgICBwYXJzZWQgPSB1cmxwYXJzZShhdXRob3JpemF0aW9uX3Jlc3BvbnNlKQogICAgICAgICAgICAgICAgICAgIHBhcmFtcyA9IHBhcnNlX3FzKHBhcnNlZC5xdWVyeSkKICAgICAgICAgICAgICAgICAgICBpZiAnY29kZScgaW4gcGFyYW1zOgogICAgICAgICAgICAgICAgICAgICAgICBjb2RlID0gcGFyYW1zWydjb2RlJ11bMF0KICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkV4dHJhY3RlZCBhdXRob3JpemF0aW9uIGNvZGUsIGZldGNoaW5nIHRva2VuLi4uIikKICAgICAgICAgICAgICAgICAgICAgICAgZmxvdy5mZXRjaF90b2tlbihjb2RlPWNvZGUpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBUcnkgYXMtaXMgaWYgaXQncyBhbHJlYWR5IGp1c3QgYSBjb2RlCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb3cuZmV0Y2hfdG9rZW4oY29kZT1hdXRob3JpemF0aW9uX3Jlc3BvbnNlKQogICAgICAgICAgICAgICAgICAgIGNyZWRzID0gZmxvdy5jcmVkZW50aWFscwogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBjcmVkcyA9IGZsb3cucnVuX2xvY2FsX3NlcnZlcihwb3J0PTApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFNhdmUgdGhlIGNyZWRlbnRpYWxzIGZvciB0aGUgbmV4dCBydW4KICAgICAgICAgICAgd2l0aCBvcGVuKHRva2VuX2ZpbGUsICd3JykgYXMgdG9rZW46CiAgICAgICAgICAgICAgICB0b2tlbi53cml0ZShjcmVkcy50b19qc29uKCkpCiAgICAgICAgCiAgICAgICAgc2VsZi5zZXJ2aWNlID0gYnVpbGQoJ2RyaXZlJywgJ3YzJywgY3JlZGVudGlhbHM9Y3JlZHMpCiAgICAgICAgbG9nZ2VyLmluZm8oIlN1Y2Nlc3NmdWxseSBhdXRoZW50aWNhdGVkIHdpdGggR29vZ2xlIERyaXZlIEFQSSIpCiAgICAKICAgIGRlZiBfY2FuX29wZW5fYnJvd3NlcihzZWxmKToKICAgICAgICAiIiJDaGVjayBpZiB3ZSBjYW4gb3BlbiBhIGJyb3dzZXIuIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgd2ViYnJvd3NlcgogICAgICAgICAgICBicm93c2VyID0gd2ViYnJvd3Nlci5nZXQoKQogICAgICAgICAgICByZXR1cm4gYnJvd3NlciBpcyBub3QgTm9uZQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBsaXN0X3ppcF9maWxlcyhzZWxmLCBmb2xkZXJfaWQ6IE9wdGlvbmFsW3N0cl0gPSBOb25lLCAKICAgICAgICAgICAgICAgICAgICAgICBwYXR0ZXJuOiBPcHRpb25hbFtzdHJdID0gTm9uZSkgLT4gTGlzdFtkaWN0XToKICAgICAgICAiIiIKICAgICAgICBMaXN0IHppcCBmaWxlcyBpbiBHb29nbGUgRHJpdmUuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgZm9sZGVyX2lkOiBPcHRpb25hbCBmb2xkZXIgSUQgdG8gc2VhcmNoIGluCiAgICAgICAgICAgIHBhdHRlcm46IE9wdGlvbmFsIGZpbGUgbmFtZSBwYXR0ZXJuIChlLmcuLCAidGFrZW91dC0qLnppcCIpCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgTGlzdCBvZiBmaWxlIG1ldGFkYXRhIGRpY3Rpb25hcmllcwogICAgICAgICIiIgogICAgICAgIHF1ZXJ5ID0gIm1pbWVUeXBlPSdhcHBsaWNhdGlvbi96aXAnIG9yIG1pbWVUeXBlPSdhcHBsaWNhdGlvbi94LXppcC1jb21wcmVzc2VkJyIKICAgICAgICAKICAgICAgICBpZiBmb2xkZXJfaWQ6CiAgICAgICAgICAgIHF1ZXJ5ICs9IGYiIGFuZCAne2ZvbGRlcl9pZH0nIGluIHBhcmVudHMiCiAgICAgICAgCiAgICAgICAgcmVzdWx0cyA9IHNlbGYuc2VydmljZS5maWxlcygpLmxpc3QoCiAgICAgICAgICAgIHE9cXVlcnksCiAgICAgICAgICAgIGZpZWxkcz0iZmlsZXMoaWQsIG5hbWUsIHNpemUsIG1vZGlmaWVkVGltZSkiLAogICAgICAgICAgICBwYWdlU2l6ZT0xMDAwCiAgICAgICAgKS5leGVjdXRlKCkKICAgICAgICAKICAgICAgICBhbGxfZmlsZXMgPSByZXN1bHRzLmdldCgnZmlsZXMnLCBbXSkKICAgICAgICAKICAgICAgICAjIEZpbHRlciBieSBwYXR0ZXJuIGlmIHByb3ZpZGVkIChkbyB0aGlzIGluIFB5dGhvbiBmb3IgYmV0dGVyIHBhdHRlcm4gbWF0Y2hpbmcpCiAgICAgICAgaWYgcGF0dGVybjoKICAgICAgICAgICAgaW1wb3J0IGZubWF0Y2gKICAgICAgICAgICAgZmlsdGVyZWRfZmlsZXMgPSBbXQogICAgICAgICAgICBmb3IgZmlsZV9pbmZvIGluIGFsbF9maWxlczoKICAgICAgICAgICAgICAgIGZpbGVfbmFtZSA9IGZpbGVfaW5mby5nZXQoJ25hbWUnLCAnJykKICAgICAgICAgICAgICAgICMgVXNlIGZubWF0Y2ggZm9yIHByb3BlciB3aWxkY2FyZCBtYXRjaGluZwogICAgICAgICAgICAgICAgaWYgZm5tYXRjaC5mbm1hdGNoKGZpbGVfbmFtZS5sb3dlcigpLCBwYXR0ZXJuLmxvd2VyKCkpOgogICAgICAgICAgICAgICAgICAgIGZpbHRlcmVkX2ZpbGVzLmFwcGVuZChmaWxlX2luZm8pCiAgICAgICAgICAgIGZpbGVzID0gZmlsdGVyZWRfZmlsZXMKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJGb3VuZCB7bGVuKGZpbGVzKX0gemlwIGZpbGVzIG1hdGNoaW5nIHBhdHRlcm4gJ3twYXR0ZXJufScgKG91dCBvZiB7bGVuKGFsbF9maWxlcyl9IHRvdGFsIHppcCBmaWxlcykiKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGZpbGVzID0gYWxsX2ZpbGVzCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiRm91bmQge2xlbihmaWxlcyl9IHppcCBmaWxlcyBpbiBHb29nbGUgRHJpdmUiKQogICAgICAgIAogICAgICAgICMgTG9nIGZpbGUgbmFtZXMgZm9yIGRlYnVnZ2luZwogICAgICAgIGlmIGZpbGVzOgogICAgICAgICAgICBsb2dnZXIuaW5mbygiRmlsZXMgdG8gZG93bmxvYWQ6IikKICAgICAgICAgICAgZm9yIGZpbGVfaW5mbyBpbiBmaWxlc1s6MTBdOiAgIyBTaG93IGZpcnN0IDEwCiAgICAgICAgICAgICAgICBzaXplID0gZmlsZV9pbmZvLmdldCgnc2l6ZScsICcwJykKICAgICAgICAgICAgICAgICMgQ29udmVydCBzaXplIHRvIGludCAoR29vZ2xlIERyaXZlIEFQSSByZXR1cm5zIGl0IGFzIHN0cmluZykKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzaXplX21iID0gaW50KHNpemUpIC8gMTAyNCAvIDEwMjQKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIiAgLSB7ZmlsZV9pbmZvLmdldCgnbmFtZScpfSAoe3NpemVfbWI6LjFmfSBNQikiKQogICAgICAgICAgICAgICAgZXhjZXB0IChWYWx1ZUVycm9yLCBUeXBlRXJyb3IpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiICAtIHtmaWxlX2luZm8uZ2V0KCduYW1lJyl9IChzaXplIHVua25vd24pIikKICAgICAgICAgICAgaWYgbGVuKGZpbGVzKSA+IDEwOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiIgIC4uLiBhbmQge2xlbihmaWxlcykgLSAxMH0gbW9yZSBmaWxlcyIpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIGZpbGVzCiAgICAKICAgIGRlZiBfY2hlY2tfZGlza19zcGFjZShzZWxmLCBwYXRoOiBQYXRoLCByZXF1aXJlZF9ieXRlczogaW50LCAKICAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlcl9wZXJjZW50OiBmbG9hdCA9IDAuMSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBDaGVjayBpZiB0aGVyZSdzIGVub3VnaCBkaXNrIHNwYWNlIGF2YWlsYWJsZS4KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBwYXRoOiBQYXRoIHRvIGNoZWNrIGRpc2sgc3BhY2UgZm9yCiAgICAgICAgICAgIHJlcXVpcmVkX2J5dGVzOiBSZXF1aXJlZCBieXRlcwogICAgICAgICAgICBidWZmZXJfcGVyY2VudDogQWRkaXRpb25hbCBidWZmZXIgcGVyY2VudGFnZSAoZGVmYXVsdCAxMCUpCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgVHJ1ZSBpZiBlbm91Z2ggc3BhY2UsIEZhbHNlIG90aGVyd2lzZQogICAgICAgICIiIgogICAgICAgIHN0YXQgPSBzaHV0aWwuZGlza191c2FnZShwYXRoKQogICAgICAgIGF2YWlsYWJsZV9ieXRlcyA9IHN0YXQuZnJlZQogICAgICAgIHJlcXVpcmVkX3dpdGhfYnVmZmVyID0gaW50KHJlcXVpcmVkX2J5dGVzICogKDEgKyBidWZmZXJfcGVyY2VudCkpCiAgICAgICAgCiAgICAgICAgaWYgYXZhaWxhYmxlX2J5dGVzIDwgcmVxdWlyZWRfd2l0aF9idWZmZXI6CiAgICAgICAgICAgIGF2YWlsYWJsZV9nYiA9IGF2YWlsYWJsZV9ieXRlcyAvICgxMDI0ICoqIDMpCiAgICAgICAgICAgIHJlcXVpcmVkX2diID0gcmVxdWlyZWRfd2l0aF9idWZmZXIgLyAoMTAyNCAqKiAzKQogICAgICAgICAgICBsb2dnZXIuZXJyb3IoCiAgICAgICAgICAgICAgICBmIkluc3VmZmljaWVudCBkaXNrIHNwYWNlOiB7YXZhaWxhYmxlX2diOi4yZn0gR0IgYXZhaWxhYmxlLCAiCiAgICAgICAgICAgICAgICBmIntyZXF1aXJlZF9nYjouMmZ9IEdCIHJlcXVpcmVkICh3aXRoIHtidWZmZXJfcGVyY2VudCoxMDA6LjBmfSUgYnVmZmVyKSIKICAgICAgICAgICAgKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgCiAgICBkZWYgZG93bmxvYWRfZmlsZShzZWxmLCBmaWxlX2lkOiBzdHIsIGZpbGVfbmFtZTogc3RyLCAKICAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb25fZGlyOiBQYXRoLCBmaWxlX3NpemU6IE9wdGlvbmFsW2ludF0gPSBOb25lKSAtPiBQYXRoOgogICAgICAgICIiIgogICAgICAgIERvd25sb2FkIGEgZmlsZSBmcm9tIEdvb2dsZSBEcml2ZS4KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBmaWxlX2lkOiBHb29nbGUgRHJpdmUgZmlsZSBJRAogICAgICAgICAgICBmaWxlX25hbWU6IE5hbWUgb2YgdGhlIGZpbGUKICAgICAgICAgICAgZGVzdGluYXRpb25fZGlyOiBEaXJlY3RvcnkgdG8gc2F2ZSB0aGUgZmlsZQogICAgICAgICAgICBmaWxlX3NpemU6IE9wdGlvbmFsIGZpbGUgc2l6ZSBpbiBieXRlcyAoZm9yIGRpc2sgc3BhY2UgY2hlY2tpbmcpCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgUGF0aCB0byBkb3dubG9hZGVkIGZpbGUKICAgICAgICAiIiIKICAgICAgICBkZXN0aW5hdGlvbl9kaXIubWtkaXIocGFyZW50cz1UcnVlLCBleGlzdF9vaz1UcnVlKQogICAgICAgIGRlc3RpbmF0aW9uX3BhdGggPSBkZXN0aW5hdGlvbl9kaXIgLyBmaWxlX25hbWUKICAgICAgICAKICAgICAgICAjIFNraXAgaWYgZmlsZSBhbHJlYWR5IGV4aXN0cwogICAgICAgIGlmIGRlc3RpbmF0aW9uX3BhdGguZXhpc3RzKCk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiRmlsZSB7ZmlsZV9uYW1lfSBhbHJlYWR5IGV4aXN0cywgc2tpcHBpbmcgZG93bmxvYWQiKQogICAgICAgICAgICByZXR1cm4gZGVzdGluYXRpb25fcGF0aAogICAgICAgIAogICAgICAgICMgQ2hlY2sgZGlzayBzcGFjZSBiZWZvcmUgZG93bmxvYWRpbmcKICAgICAgICBpZiBmaWxlX3NpemU6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9jaGVja19kaXNrX3NwYWNlKGRlc3RpbmF0aW9uX2RpciwgZmlsZV9zaXplKToKICAgICAgICAgICAgICAgIHJhaXNlIE9TRXJyb3IoCiAgICAgICAgICAgICAgICAgICAgZiJJbnN1ZmZpY2llbnQgZGlzayBzcGFjZSB0byBkb3dubG9hZCB7ZmlsZV9uYW1lfSAiCiAgICAgICAgICAgICAgICAgICAgZiIoe2ZpbGVfc2l6ZSAvICgxMDI0KiozKTouMmZ9IEdCKSIKICAgICAgICAgICAgICAgICkKICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIkRvd25sb2FkaW5nIHtmaWxlX25hbWV9Li4uIikKICAgICAgICAKICAgICAgICByZXF1ZXN0ID0gc2VsZi5zZXJ2aWNlLmZpbGVzKCkuZ2V0X21lZGlhKGZpbGVJZD1maWxlX2lkKQogICAgICAgIGZoID0gaW8uRmlsZUlPKGRlc3RpbmF0aW9uX3BhdGgsICd3YicpCiAgICAgICAgZG93bmxvYWRlciA9IE1lZGlhSW9CYXNlRG93bmxvYWQoZmgsIHJlcXVlc3QpCiAgICAgICAgCiAgICAgICAgZG9uZSA9IEZhbHNlCiAgICAgICAgd2hpbGUgZG9uZSBpcyBGYWxzZToKICAgICAgICAgICAgc3RhdHVzLCBkb25lID0gZG93bmxvYWRlci5uZXh0X2NodW5rKCkKICAgICAgICAgICAgaWYgc3RhdHVzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiRG93bmxvYWQgcHJvZ3Jlc3M6IHtpbnQoc3RhdHVzLnByb2dyZXNzKCkgKiAxMDApfSUiKQogICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKGYiRG93bmxvYWRlZCB7ZmlsZV9uYW1lfSAoe2Rlc3RpbmF0aW9uX3BhdGguc3RhdCgpLnN0X3NpemUgLyAxMDI0IC8gMTAyNDouMmZ9IE1CKSIpCiAgICAgICAgcmV0dXJuIGRlc3RpbmF0aW9uX3BhdGgKICAgIAogICAgZGVmIGRvd25sb2FkX2FsbF96aXBzKHNlbGYsIGRlc3RpbmF0aW9uX2RpcjogUGF0aCwgCiAgICAgICAgICAgICAgICAgICAgICAgICBmb2xkZXJfaWQ6IE9wdGlvbmFsW3N0cl0gPSBOb25lLAogICAgICAgICAgICAgICAgICAgICAgICAgcGF0dGVybjogT3B0aW9uYWxbc3RyXSA9IE5vbmUpIC0+IExpc3RbUGF0aF06CiAgICAgICAgIiIiCiAgICAgICAgRG93bmxvYWQgYWxsIHppcCBmaWxlcyBtYXRjaGluZyBjcml0ZXJpYS4KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBkZXN0aW5hdGlvbl9kaXI6IERpcmVjdG9yeSB0byBzYXZlIHppcCBmaWxlcwogICAgICAgICAgICBmb2xkZXJfaWQ6IE9wdGlvbmFsIGZvbGRlciBJRCB0byBzZWFyY2ggaW4KICAgICAgICAgICAgcGF0dGVybjogT3B0aW9uYWwgZmlsZSBuYW1lIHBhdHRlcm4KICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0IG9mIHBhdGhzIHRvIGRvd25sb2FkZWQgZmlsZXMKICAgICAgICAiIiIKICAgICAgICBmaWxlcyA9IHNlbGYubGlzdF96aXBfZmlsZXMoZm9sZGVyX2lkPWZvbGRlcl9pZCwgcGF0dGVybj1wYXR0ZXJuKQogICAgICAgIGRvd25sb2FkZWRfZmlsZXMgPSBbXQogICAgICAgIAogICAgICAgIGZvciBmaWxlX2luZm8gaW4gZmlsZXM6CiAgICAgICAgICAgIGZpbGVfc2l6ZSA9IE5vbmUKICAgICAgICAgICAgaWYgJ3NpemUnIGluIGZpbGVfaW5mbzoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBmaWxlX3NpemUgPSBpbnQoZmlsZV9pbmZvWydzaXplJ10pCiAgICAgICAgICAgICAgICBleGNlcHQgKFZhbHVlRXJyb3IsIFR5cGVFcnJvcik6CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAKICAgICAgICAgICAgZmlsZV9wYXRoID0gc2VsZi5kb3dubG9hZF9maWxlKAogICAgICAgICAgICAgICAgZmlsZV9pbmZvWydpZCddLAogICAgICAgICAgICAgICAgZmlsZV9pbmZvWyduYW1lJ10sCiAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbl9kaXIsCiAgICAgICAgICAgICAgICBmaWxlX3NpemU9ZmlsZV9zaXplCiAgICAgICAgICAgICkKICAgICAgICAgICAgZG93bmxvYWRlZF9maWxlcy5hcHBlbmQoZmlsZV9wYXRoKQogICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKGYiRG93bmxvYWRlZCB7bGVuKGRvd25sb2FkZWRfZmlsZXMpfSB6aXAgZmlsZXMiKQogICAgICAgIHJldHVybiBkb3dubG9hZGVkX2ZpbGVzCiAgICAKICAgIGRlZiBkb3dubG9hZF9zaW5nbGVfemlwKHNlbGYsIGZpbGVfaW5mbzogZGljdCwgZGVzdGluYXRpb25fZGlyOiBQYXRoKSAtPiBQYXRoOgogICAgICAgICIiIgogICAgICAgIERvd25sb2FkIGEgc2luZ2xlIHppcCBmaWxlLgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGZpbGVfaW5mbzogRmlsZSBtZXRhZGF0YSBkaWN0aW9uYXJ5IHdpdGggJ2lkJywgJ25hbWUnLCBhbmQgb3B0aW9uYWxseSAnc2l6ZScKICAgICAgICAgICAgZGVzdGluYXRpb25fZGlyOiBEaXJlY3RvcnkgdG8gc2F2ZSB6aXAgZmlsZQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIFBhdGggdG8gZG93bmxvYWRlZCBmaWxlCiAgICAgICAgIiIiCiAgICAgICAgZmlsZV9zaXplID0gTm9uZQogICAgICAgIGlmICdzaXplJyBpbiBmaWxlX2luZm86CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGZpbGVfc2l6ZSA9IGludChmaWxlX2luZm9bJ3NpemUnXSkKICAgICAgICAgICAgZXhjZXB0IChWYWx1ZUVycm9yLCBUeXBlRXJyb3IpOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIAogICAgICAgIHJldHVybiBzZWxmLmRvd25sb2FkX2ZpbGUoCiAgICAgICAgICAgIGZpbGVfaW5mb1snaWQnXSwKICAgICAgICAgICAgZmlsZV9pbmZvWyduYW1lJ10sCiAgICAgICAgICAgIGRlc3RpbmF0aW9uX2RpciwKICAgICAgICAgICAgZmlsZV9zaXplPWZpbGVfc2l6ZQogICAgICAgICkKCg=="""

# Base64 encoded main.py  
MAIN_B64 = """IiIiCk1haW4gb3JjaGVzdHJhdGlvbiBzY3JpcHQgZm9yIEdvb2dsZSBQaG90b3MgdG8gaUNsb3VkIFBob3RvcyBtaWdyYXRpb24uCiIiIgppbXBvcnQgYXJncGFyc2UKaW1wb3J0IGxvZ2dpbmcKaW1wb3J0IHN5cwpmcm9tIHBhdGhsaWIgaW1wb3J0IFBhdGgKZnJvbSB0eXBpbmcgaW1wb3J0IERpY3QsIExpc3QsIE9wdGlvbmFsCmltcG9ydCB5YW1sCmZyb20gdHFkbSBpbXBvcnQgdHFkbQoKZnJvbSBkcml2ZV9kb3dubG9hZGVyIGltcG9ydCBEcml2ZURvd25sb2FkZXIKZnJvbSBleHRyYWN0b3IgaW1wb3J0IEV4dHJhY3Rvcgpmcm9tIG1ldGFkYXRhX21lcmdlciBpbXBvcnQgTWV0YWRhdGFNZXJnZXIKZnJvbSBhbGJ1bV9wYXJzZXIgaW1wb3J0IEFsYnVtUGFyc2VyCmZyb20gaWNsb3VkX3VwbG9hZGVyIGltcG9ydCBpQ2xvdWRVcGxvYWRlciwgaUNsb3VkUGhvdG9zU3luY1VwbG9hZGVyCgpsb2dnZXIgPSBsb2dnaW5nLmdldExvZ2dlcihfX25hbWVfXykKCgpjbGFzcyBNaWdyYXRpb25PcmNoZXN0cmF0b3I6CiAgICAiIiJPcmNoZXN0cmF0ZXMgdGhlIGVudGlyZSBtaWdyYXRpb24gcHJvY2Vzcy4iIiIKICAgIAogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNvbmZpZ19wYXRoOiBzdHIpOgogICAgICAgICIiIgogICAgICAgIEluaXRpYWxpemUgdGhlIG9yY2hlc3RyYXRvci4KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBjb25maWdfcGF0aDogUGF0aCB0byBjb25maWd1cmF0aW9uIFlBTUwgZmlsZQogICAgICAgICIiIgogICAgICAgIHNlbGYuY29uZmlnID0gc2VsZi5fbG9hZF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAgICAgc2VsZi5fc2V0dXBfbG9nZ2luZygpCiAgICAgICAgCiAgICAgICAgIyBJbml0aWFsaXplIGNvbXBvbmVudHMKICAgICAgICBzZWxmLmJhc2VfZGlyID0gUGF0aChzZWxmLmNvbmZpZ1sncHJvY2Vzc2luZyddWydiYXNlX2RpciddKQogICAgICAgIHNlbGYuYmFzZV9kaXIubWtkaXIocGFyZW50cz1UcnVlLCBleGlzdF9vaz1UcnVlKQogICAgICAgIAogICAgICAgICMgSW5pdGlhbGl6ZSBkb3dubG9hZGVyCiAgICAgICAgZHJpdmVfY29uZmlnID0gc2VsZi5jb25maWdbJ2dvb2dsZV9kcml2ZSddCiAgICAgICAgc2VsZi5kb3dubG9hZGVyID0gRHJpdmVEb3dubG9hZGVyKGRyaXZlX2NvbmZpZ1snY3JlZGVudGlhbHNfZmlsZSddKQogICAgICAgIAogICAgICAgICMgSW5pdGlhbGl6ZSBleHRyYWN0b3IKICAgICAgICBzZWxmLmV4dHJhY3RvciA9IEV4dHJhY3RvcihzZWxmLmJhc2VfZGlyKQogICAgICAgIAogICAgICAgICMgSW5pdGlhbGl6ZSBtZXRhZGF0YSBtZXJnZXIKICAgICAgICBtZXRhZGF0YV9jb25maWcgPSBzZWxmLmNvbmZpZ1snbWV0YWRhdGEnXQogICAgICAgIHNlbGYubWV0YWRhdGFfbWVyZ2VyID0gTWV0YWRhdGFNZXJnZXIoCiAgICAgICAgICAgIHByZXNlcnZlX2RhdGVzPW1ldGFkYXRhX2NvbmZpZ1sncHJlc2VydmVfZGF0ZXMnXSwKICAgICAgICAgICAgcHJlc2VydmVfZ3BzPW1ldGFkYXRhX2NvbmZpZ1sncHJlc2VydmVfZ3BzJ10sCiAgICAgICAgICAgIHByZXNlcnZlX2Rlc2NyaXB0aW9ucz1tZXRhZGF0YV9jb25maWdbJ3ByZXNlcnZlX2Rlc2NyaXB0aW9ucyddCiAgICAgICAgKQogICAgICAgIAogICAgICAgICMgSW5pdGlhbGl6ZSBhbGJ1bSBwYXJzZXIKICAgICAgICBzZWxmLmFsYnVtX3BhcnNlciA9IEFsYnVtUGFyc2VyKCkKICAgICAgICAKICAgICAgICAjIEluaXRpYWxpemUgaUNsb3VkIHVwbG9hZGVyICh3aWxsIGJlIHNldCB1cCBsYXRlcikKICAgICAgICBzZWxmLmljbG91ZF91cGxvYWRlciA9IE5vbmUKICAgIAogICAgZGVmIF9sb2FkX2NvbmZpZyhzZWxmLCBjb25maWdfcGF0aDogc3RyKSAtPiBEaWN0OgogICAgICAgICIiIkxvYWQgY29uZmlndXJhdGlvbiBmcm9tIFlBTUwgZmlsZS4iIiIKICAgICAgICB3aXRoIG9wZW4oY29uZmlnX3BhdGgsICdyJykgYXMgZjoKICAgICAgICAgICAgcmV0dXJuIHlhbWwuc2FmZV9sb2FkKGYpCiAgICAKICAgIGRlZiBfc2V0dXBfbG9nZ2luZyhzZWxmKToKICAgICAgICAiIiJTZXQgdXAgbG9nZ2luZyBjb25maWd1cmF0aW9uLiIiIgogICAgICAgIGxvZ19jb25maWcgPSBzZWxmLmNvbmZpZy5nZXQoJ2xvZ2dpbmcnLCB7fSkKICAgICAgICBsZXZlbCA9IGdldGF0dHIobG9nZ2luZywgbG9nX2NvbmZpZy5nZXQoJ2xldmVsJywgJ0lORk8nKSkKICAgICAgICBsb2dfZmlsZSA9IGxvZ19jb25maWcuZ2V0KCdmaWxlJywgJ21pZ3JhdGlvbi5sb2cnKQogICAgICAgIAogICAgICAgIGNsYXNzIFNhZmVGaWxlSGFuZGxlcihsb2dnaW5nLkZpbGVIYW5kbGVyKToKICAgICAgICAgICAgIiIiRmlsZSBoYW5kbGVyIHRoYXQgZ3JhY2VmdWxseSBoYW5kbGVzIGRpc2sgc3BhY2UgZXJyb3JzLiIiIgogICAgICAgICAgICBkZWYgZW1pdChzZWxmLCByZWNvcmQpOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHN1cGVyKCkuZW1pdChyZWNvcmQpCiAgICAgICAgICAgICAgICBleGNlcHQgT1NFcnJvciBhcyBlOgogICAgICAgICAgICAgICAgICAgIGlmIGUuZXJybm8gPT0gMjg6ICAjIE5vIHNwYWNlIGxlZnQgb24gZGV2aWNlCiAgICAgICAgICAgICAgICAgICAgICAgICMgU2lsZW50bHkgc2tpcCBsb2dnaW5nIHRvIGZpbGUgaWYgZGlzayBpcyBmdWxsCiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICByYWlzZQogICAgICAgIAogICAgICAgIGhhbmRsZXJzID0gW2xvZ2dpbmcuU3RyZWFtSGFuZGxlcihzeXMuc3Rkb3V0KV0KICAgICAgICAKICAgICAgICAjIFRyeSB0byBhZGQgZmlsZSBoYW5kbGVyLCBidXQgZG9uJ3QgZmFpbCBpZiBkaXNrIGlzIGZ1bGwKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZpbGVfaGFuZGxlciA9IFNhZmVGaWxlSGFuZGxlcihsb2dfZmlsZSkKICAgICAgICAgICAgaGFuZGxlcnMuYXBwZW5kKGZpbGVfaGFuZGxlcikKICAgICAgICBleGNlcHQgKE9TRXJyb3IsIElPRXJyb3IpIGFzIGU6CiAgICAgICAgICAgICMgSWYgd2UgY2FuJ3QgY3JlYXRlIGxvZyBmaWxlIChlLmcuLCBubyBkaXNrIHNwYWNlKSwganVzdCB1c2UgY29uc29sZQogICAgICAgICAgICBwcmludChmIldhcm5pbmc6IENvdWxkIG5vdCBjcmVhdGUgbG9nIGZpbGUgJ3tsb2dfZmlsZX0nOiB7ZX0iLCBmaWxlPXN5cy5zdGRlcnIpCiAgICAgICAgICAgIHByaW50KCJDb250aW51aW5nIHdpdGggY29uc29sZSBsb2dnaW5nIG9ubHkuIiwgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgIAogICAgICAgIGxvZ2dpbmcuYmFzaWNDb25maWcoCiAgICAgICAgICAgIGxldmVsPWxldmVsLAogICAgICAgICAgICBmb3JtYXQ9JyUoYXNjdGltZSlzIC0gJShuYW1lKXMgLSAlKGxldmVsbmFtZSlzIC0gJShtZXNzYWdlKXMnLAogICAgICAgICAgICBoYW5kbGVycz1oYW5kbGVycwogICAgICAgICkKICAgIAogICAgZGVmIGRvd25sb2FkX3ppcF9maWxlcyhzZWxmKSAtPiBMaXN0W1BhdGhdOgogICAgICAgICIiIgogICAgICAgIERvd25sb2FkIGFsbCB6aXAgZmlsZXMgZnJvbSBHb29nbGUgRHJpdmUuCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgTGlzdCBvZiBkb3dubG9hZGVkIHppcCBmaWxlIHBhdGhzCiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIj0iICogNjApCiAgICAgICAgbG9nZ2VyLmluZm8oIlBoYXNlIDE6IERvd25sb2FkaW5nIHppcCBmaWxlcyBmcm9tIEdvb2dsZSBEcml2ZSIpCiAgICAgICAgbG9nZ2VyLmluZm8oIj0iICogNjApCiAgICAgICAgCiAgICAgICAgZHJpdmVfY29uZmlnID0gc2VsZi5jb25maWdbJ2dvb2dsZV9kcml2ZSddCiAgICAgICAgemlwX2RpciA9IHNlbGYuYmFzZV9kaXIgLyBzZWxmLmNvbmZpZ1sncHJvY2Vzc2luZyddWyd6aXBfZGlyJ10KICAgICAgICAKICAgICAgICB6aXBfZmlsZXMgPSBzZWxmLmRvd25sb2FkZXIuZG93bmxvYWRfYWxsX3ppcHMoCiAgICAgICAgICAgIGRlc3RpbmF0aW9uX2Rpcj16aXBfZGlyLAogICAgICAgICAgICBmb2xkZXJfaWQ9ZHJpdmVfY29uZmlnLmdldCgnZm9sZGVyX2lkJykgb3IgTm9uZSwKICAgICAgICAgICAgcGF0dGVybj1kcml2ZV9jb25maWcuZ2V0KCd6aXBfZmlsZV9wYXR0ZXJuJykgb3IgTm9uZQogICAgICAgICkKICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIkRvd25sb2FkZWQge2xlbih6aXBfZmlsZXMpfSB6aXAgZmlsZXMiKQogICAgICAgIHJldHVybiB6aXBfZmlsZXMKICAgIAogICAgZGVmIGV4dHJhY3RfZmlsZXMoc2VsZiwgemlwX2ZpbGVzOiBMaXN0W1BhdGhdKSAtPiBMaXN0W1BhdGhdOgogICAgICAgICIiIgogICAgICAgIEV4dHJhY3QgYWxsIHppcCBmaWxlcy4KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB6aXBfZmlsZXM6IExpc3Qgb2YgemlwIGZpbGUgcGF0aHMKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0IG9mIGV4dHJhY3RlZCBkaXJlY3RvcnkgcGF0aHMKICAgICAgICAiIiIKICAgICAgICBsb2dnZXIuaW5mbygiPSIgKiA2MCkKICAgICAgICBsb2dnZXIuaW5mbygiUGhhc2UgMjogRXh0cmFjdGluZyB6aXAgZmlsZXMiKQogICAgICAgIGxvZ2dlci5pbmZvKCI9IiAqIDYwKQogICAgICAgIAogICAgICAgIGV4dHJhY3RlZF9kaXJzID0gc2VsZi5leHRyYWN0b3IuZXh0cmFjdF9hbGxfemlwcyh6aXBfZmlsZXMpCiAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oZiJFeHRyYWN0ZWQge2xlbihleHRyYWN0ZWRfZGlycyl9IHppcCBmaWxlcyIpCiAgICAgICAgcmV0dXJuIGV4dHJhY3RlZF9kaXJzCiAgICAKICAgIGRlZiBwcm9jZXNzX21ldGFkYXRhKHNlbGYsIGV4dHJhY3RlZF9kaXJzOiBMaXN0W1BhdGhdKSAtPiBEaWN0W1BhdGgsIE9wdGlvbmFsW1BhdGhdXToKICAgICAgICAiIiIKICAgICAgICBQcm9jZXNzIG1ldGFkYXRhIGZvciBhbGwgZXh0cmFjdGVkIGZpbGVzLgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGV4dHJhY3RlZF9kaXJzOiBMaXN0IG9mIGV4dHJhY3RlZCBkaXJlY3RvcnkgcGF0aHMKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0aW9uYXJ5IG1hcHBpbmcgbWVkaWEgZmlsZXMgdG8gSlNPTiBtZXRhZGF0YSBmaWxlcwogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCI9IiAqIDYwKQogICAgICAgIGxvZ2dlci5pbmZvKCJQaGFzZSAzOiBQcm9jZXNzaW5nIG1ldGFkYXRhIikKICAgICAgICBsb2dnZXIuaW5mbygiPSIgKiA2MCkKICAgICAgICAKICAgICAgICAjIENvbGxlY3QgYWxsIG1lZGlhL0pTT04gcGFpcnMKICAgICAgICBhbGxfcGFpcnMgPSB7fQogICAgICAgIAogICAgICAgIGZvciBleHRyYWN0ZWRfZGlyIGluIGV4dHJhY3RlZF9kaXJzOgogICAgICAgICAgICBwYWlycyA9IHNlbGYuZXh0cmFjdG9yLmlkZW50aWZ5X21lZGlhX2pzb25fcGFpcnMoZXh0cmFjdGVkX2RpcikKICAgICAgICAgICAgYWxsX3BhaXJzLnVwZGF0ZShwYWlycykKICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIkZvdW5kIHtsZW4oYWxsX3BhaXJzKX0gbWVkaWEgZmlsZXMgdG8gcHJvY2VzcyIpCiAgICAgICAgCiAgICAgICAgIyBNZXJnZSBtZXRhZGF0YQogICAgICAgIHByb2Nlc3NlZF9kaXIgPSBzZWxmLmJhc2VfZGlyIC8gc2VsZi5jb25maWdbJ3Byb2Nlc3NpbmcnXVsncHJvY2Vzc2VkX2RpciddCiAgICAgICAgcHJvY2Vzc2VkX2Rpci5ta2RpcihwYXJlbnRzPVRydWUsIGV4aXN0X29rPVRydWUpCiAgICAgICAgCiAgICAgICAgIyBQcm9jZXNzIGluIGJhdGNoZXMKICAgICAgICBiYXRjaF9zaXplID0gc2VsZi5jb25maWdbJ3Byb2Nlc3NpbmcnXVsnYmF0Y2hfc2l6ZSddCiAgICAgICAgYWxsX2ZpbGVzID0gbGlzdChhbGxfcGFpcnMua2V5cygpKQogICAgICAgIAogICAgICAgIGZvciBpIGluIHJhbmdlKDAsIGxlbihhbGxfZmlsZXMpLCBiYXRjaF9zaXplKToKICAgICAgICAgICAgYmF0Y2ggPSBhbGxfZmlsZXNbaTppICsgYmF0Y2hfc2l6ZV0KICAgICAgICAgICAgYmF0Y2hfcGFpcnMgPSB7ZjogYWxsX3BhaXJzW2ZdIGZvciBmIGluIGJhdGNofQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJQcm9jZXNzaW5nIGJhdGNoIHtpIC8vIGJhdGNoX3NpemUgKyAxfS97KGxlbihhbGxfZmlsZXMpICsgYmF0Y2hfc2l6ZSAtIDEpIC8vIGJhdGNoX3NpemV9IikKICAgICAgICAgICAgc2VsZi5tZXRhZGF0YV9tZXJnZXIubWVyZ2VfYWxsX21ldGFkYXRhKGJhdGNoX3BhaXJzLCBvdXRwdXRfZGlyPXByb2Nlc3NlZF9kaXIpCiAgICAgICAgCiAgICAgICAgIyBVcGRhdGUgcGFpcnMgdG8gcG9pbnQgdG8gcHJvY2Vzc2VkIGZpbGVzCiAgICAgICAgcHJvY2Vzc2VkX3BhaXJzID0ge30KICAgICAgICBmb3IgbWVkaWFfZmlsZSwganNvbl9maWxlIGluIGFsbF9wYWlycy5pdGVtcygpOgogICAgICAgICAgICBwcm9jZXNzZWRfZmlsZSA9IHByb2Nlc3NlZF9kaXIgLyBtZWRpYV9maWxlLm5hbWUKICAgICAgICAgICAgaWYgcHJvY2Vzc2VkX2ZpbGUuZXhpc3RzKCk6CiAgICAgICAgICAgICAgICBwcm9jZXNzZWRfcGFpcnNbcHJvY2Vzc2VkX2ZpbGVdID0ganNvbl9maWxlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIEZhbGxiYWNrIHRvIG9yaWdpbmFsIGlmIHByb2Nlc3NpbmcgZmFpbGVkCiAgICAgICAgICAgICAgICBwcm9jZXNzZWRfcGFpcnNbbWVkaWFfZmlsZV0gPSBqc29uX2ZpbGUKICAgICAgICAKICAgICAgICByZXR1cm4gcHJvY2Vzc2VkX3BhaXJzCiAgICAKICAgIGRlZiBwYXJzZV9hbGJ1bXMoc2VsZiwgbWVkaWFfanNvbl9wYWlyczogRGljdFtQYXRoLCBPcHRpb25hbFtQYXRoXV0sCiAgICAgICAgICAgICAgICAgICAgZXh0cmFjdGVkX2RpcnM6IExpc3RbUGF0aF0pIC0+IERpY3Rbc3RyLCBMaXN0W1BhdGhdXToKICAgICAgICAiIiIKICAgICAgICBQYXJzZSBhbGJ1bSBzdHJ1Y3R1cmVzIGZyb20gZXh0cmFjdGVkIGZpbGVzLgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIG1lZGlhX2pzb25fcGFpcnM6IERpY3Rpb25hcnkgbWFwcGluZyBtZWRpYSBmaWxlcyB0byBKU09OIGZpbGVzCiAgICAgICAgICAgIGV4dHJhY3RlZF9kaXJzOiBMaXN0IG9mIGV4dHJhY3RlZCBkaXJlY3RvcnkgcGF0aHMKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0aW9uYXJ5IG1hcHBpbmcgYWxidW0gbmFtZXMgdG8gZmlsZSBsaXN0cwogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCI9IiAqIDYwKQogICAgICAgIGxvZ2dlci5pbmZvKCJQaGFzZSA0OiBQYXJzaW5nIGFsYnVtIHN0cnVjdHVyZXMiKQogICAgICAgIGxvZ2dlci5pbmZvKCI9IiAqIDYwKQogICAgICAgIAogICAgICAgICMgUGFyc2UgZnJvbSBkaXJlY3Rvcnkgc3RydWN0dXJlCiAgICAgICAgZm9yIGV4dHJhY3RlZF9kaXIgaW4gZXh0cmFjdGVkX2RpcnM6CiAgICAgICAgICAgIHNlbGYuYWxidW1fcGFyc2VyLnBhcnNlX2Zyb21fZGlyZWN0b3J5X3N0cnVjdHVyZShleHRyYWN0ZWRfZGlyKQogICAgICAgIAogICAgICAgICMgUGFyc2UgZnJvbSBKU09OIG1ldGFkYXRhCiAgICAgICAgc2VsZi5hbGJ1bV9wYXJzZXIucGFyc2VfZnJvbV9qc29uX21ldGFkYXRhKG1lZGlhX2pzb25fcGFpcnMpCiAgICAgICAgCiAgICAgICAgYWxidW1zID0gc2VsZi5hbGJ1bV9wYXJzZXIuZ2V0X2FsbF9hbGJ1bXMoKQogICAgICAgIGxvZ2dlci5pbmZvKGYiSWRlbnRpZmllZCB7bGVuKGFsYnVtcyl9IGFsYnVtcyIpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIGFsYnVtcwogICAgCiAgICBkZWYgc2V0dXBfaWNsb3VkX3VwbG9hZGVyKHNlbGYsIHVzZV9zeW5jX21ldGhvZDogYm9vbCA9IEZhbHNlKToKICAgICAgICAiIiIKICAgICAgICBTZXQgdXAgaUNsb3VkIHVwbG9hZGVyLgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHVzZV9zeW5jX21ldGhvZDogSWYgVHJ1ZSwgdXNlIFBob3RvcyBsaWJyYXJ5IHN5bmMgbWV0aG9kCiAgICAgICAgIiIiCiAgICAgICAgaWNsb3VkX2NvbmZpZyA9IHNlbGYuY29uZmlnWydpY2xvdWQnXQogICAgICAgIAogICAgICAgIGlmIHVzZV9zeW5jX21ldGhvZDoKICAgICAgICAgICAgc2VsZi5pY2xvdWRfdXBsb2FkZXIgPSBpQ2xvdWRQaG90b3NTeW5jVXBsb2FkZXIoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYuaWNsb3VkX3VwbG9hZGVyID0gaUNsb3VkVXBsb2FkZXIoCiAgICAgICAgICAgICAgICBhcHBsZV9pZD1pY2xvdWRfY29uZmlnWydhcHBsZV9pZCddLAogICAgICAgICAgICAgICAgcGFzc3dvcmQ9aWNsb3VkX2NvbmZpZy5nZXQoJ3Bhc3N3b3JkJywgJycpLAogICAgICAgICAgICAgICAgdHJ1c3RlZF9kZXZpY2VfaWQ9aWNsb3VkX2NvbmZpZy5nZXQoJ3RydXN0ZWRfZGV2aWNlX2lkJykKICAgICAgICAgICAgKQogICAgCiAgICBkZWYgdXBsb2FkX3RvX2ljbG91ZChzZWxmLCBtZWRpYV9qc29uX3BhaXJzOiBEaWN0W1BhdGgsIE9wdGlvbmFsW1BhdGhdXSwKICAgICAgICAgICAgICAgICAgICAgICAgYWxidW1zOiBEaWN0W3N0ciwgTGlzdFtQYXRoXV0pIC0+IERpY3RbUGF0aCwgYm9vbF06CiAgICAgICAgIiIiCiAgICAgICAgVXBsb2FkIHByb2Nlc3NlZCBmaWxlcyB0byBpQ2xvdWQgUGhvdG9zLgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIG1lZGlhX2pzb25fcGFpcnM6IERpY3Rpb25hcnkgbWFwcGluZyBtZWRpYSBmaWxlcyB0byBKU09OIGZpbGVzCiAgICAgICAgICAgIGFsYnVtczogRGljdGlvbmFyeSBtYXBwaW5nIGFsYnVtIG5hbWVzIHRvIGZpbGUgbGlzdHMKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0aW9uYXJ5IG1hcHBpbmcgZmlsZSBwYXRocyB0byB1cGxvYWQgc3VjY2VzcyBzdGF0dXMKICAgICAgICAiIiIKICAgICAgICBsb2dnZXIuaW5mbygiPSIgKiA2MCkKICAgICAgICBsb2dnZXIuaW5mbygiUGhhc2UgNTogVXBsb2FkaW5nIHRvIGlDbG91ZCBQaG90b3MiKQogICAgICAgIGxvZ2dlci5pbmZvKCI9IiAqIDYwKQogICAgICAgIAogICAgICAgIGlmIHNlbGYuaWNsb3VkX3VwbG9hZGVyIGlzIE5vbmU6CiAgICAgICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcigiaUNsb3VkIHVwbG9hZGVyIG5vdCBpbml0aWFsaXplZC4gQ2FsbCBzZXR1cF9pY2xvdWRfdXBsb2FkZXIoKSBmaXJzdC4iKQogICAgICAgIAogICAgICAgICMgQnVpbGQgZmlsZS10by1hbGJ1bSBtYXBwaW5nCiAgICAgICAgZmlsZV90b19hbGJ1bSA9IHt9CiAgICAgICAgZm9yIGFsYnVtX25hbWUsIGZpbGVzIGluIGFsYnVtcy5pdGVtcygpOgogICAgICAgICAgICBmb3IgZmlsZV9wYXRoIGluIGZpbGVzOgogICAgICAgICAgICAgICAgZmlsZV90b19hbGJ1bVtmaWxlX3BhdGhdID0gYWxidW1fbmFtZQogICAgICAgIAogICAgICAgICMgVXBsb2FkIGZpbGVzCiAgICAgICAgYWxsX2ZpbGVzID0gbGlzdChtZWRpYV9qc29uX3BhaXJzLmtleXMoKSkKICAgICAgICAKICAgICAgICBpZiBpc2luc3RhbmNlKHNlbGYuaWNsb3VkX3VwbG9hZGVyLCBpQ2xvdWRQaG90b3NTeW5jVXBsb2FkZXIpOgogICAgICAgICAgICByZXN1bHRzID0gc2VsZi5pY2xvdWRfdXBsb2FkZXIudXBsb2FkX2ZpbGVzX2JhdGNoKAogICAgICAgICAgICAgICAgYWxsX2ZpbGVzLAogICAgICAgICAgICAgICAgYWxidW1zPWZpbGVfdG9fYWxidW0KICAgICAgICAgICAgKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgR3JvdXAgYnkgYWxidW0gZm9yIHJlZ3VsYXIgdXBsb2FkZXIKICAgICAgICAgICAgcmVzdWx0cyA9IHt9CiAgICAgICAgICAgIGZvciBhbGJ1bV9uYW1lLCBmaWxlcyBpbiBhbGJ1bXMuaXRlbXMoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVXBsb2FkaW5nIGFsYnVtOiB7YWxidW1fbmFtZX0gKHtsZW4oZmlsZXMpfSBmaWxlcykiKQogICAgICAgICAgICAgICAgYWxidW1fcmVzdWx0cyA9IHNlbGYuaWNsb3VkX3VwbG9hZGVyLnVwbG9hZF9waG90b3NfYmF0Y2goCiAgICAgICAgICAgICAgICAgICAgZmlsZXMsCiAgICAgICAgICAgICAgICAgICAgYWxidW1fbmFtZT1hbGJ1bV9uYW1lCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICByZXN1bHRzLnVwZGF0ZShhbGJ1bV9yZXN1bHRzKQogICAgICAgIAogICAgICAgIHN1Y2Nlc3NmdWwgPSBzdW0oMSBmb3IgdiBpbiByZXN1bHRzLnZhbHVlcygpIGlmIHYpCiAgICAgICAgbG9nZ2VyLmluZm8oZiJVcGxvYWRlZCB7c3VjY2Vzc2Z1bH0ve2xlbihyZXN1bHRzKX0gZmlsZXMgdG8gaUNsb3VkIFBob3RvcyIpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHJlc3VsdHMKICAgIAogICAgZGVmIGNsZWFudXAoc2VsZik6CiAgICAgICAgIiIiQ2xlYW4gdXAgdGVtcG9yYXJ5IGZpbGVzLiIiIgogICAgICAgIGlmIHNlbGYuY29uZmlnWydwcm9jZXNzaW5nJ10uZ2V0KCdjbGVhbnVwX2FmdGVyX3VwbG9hZCcsIEZhbHNlKToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIj0iICogNjApCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJQaGFzZSA2OiBDbGVhbnVwIikKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIj0iICogNjApCiAgICAgICAgICAgIAogICAgICAgICAgICBleHRyYWN0ZWRfZGlyID0gc2VsZi5iYXNlX2RpciAvIHNlbGYuY29uZmlnWydwcm9jZXNzaW5nJ11bJ2V4dHJhY3RlZF9kaXInXQogICAgICAgICAgICBpZiBleHRyYWN0ZWRfZGlyLmV4aXN0cygpOgogICAgICAgICAgICAgICAgaW1wb3J0IHNodXRpbAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJSZW1vdmluZyBleHRyYWN0ZWQgZmlsZXM6IHtleHRyYWN0ZWRfZGlyfSIpCiAgICAgICAgICAgICAgICBzaHV0aWwucm10cmVlKGV4dHJhY3RlZF9kaXIpCiAgICAKICAgIGRlZiBwcm9jZXNzX3NpbmdsZV96aXAoc2VsZiwgemlwX3BhdGg6IFBhdGgsIHppcF9udW1iZXI6IGludCwgdG90YWxfemlwczogaW50LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlX3N5bmNfbWV0aG9kOiBib29sID0gRmFsc2UpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgUHJvY2VzcyBhIHNpbmdsZSB6aXAgZmlsZTogZXh0cmFjdCwgcHJvY2VzcyBtZXRhZGF0YSwgdXBsb2FkLCBjbGVhbnVwLgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHppcF9wYXRoOiBQYXRoIHRvIHppcCBmaWxlCiAgICAgICAgICAgIHppcF9udW1iZXI6IEN1cnJlbnQgemlwIG51bWJlciAoZm9yIGxvZ2dpbmcpCiAgICAgICAgICAgIHRvdGFsX3ppcHM6IFRvdGFsIG51bWJlciBvZiB6aXAgZmlsZXMKICAgICAgICAgICAgdXNlX3N5bmNfbWV0aG9kOiBXaGV0aGVyIHRvIHVzZSBQaG90b3MgbGlicmFyeSBzeW5jIG1ldGhvZAogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIFRydWUgaWYgc3VjY2Vzc2Z1bCwgRmFsc2Ugb3RoZXJ3aXNlCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiPSIgKiA2MCkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJQcm9jZXNzaW5nIHppcCB7emlwX251bWJlcn0ve3RvdGFsX3ppcHN9OiB7emlwX3BhdGgubmFtZX0iKQogICAgICAgICAgICBsb2dnZXIuaW5mbygiPSIgKiA2MCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgRXh0cmFjdCB0aGlzIHppcCBmaWxlCiAgICAgICAgICAgIGV4dHJhY3RlZF9kaXIgPSBzZWxmLmV4dHJhY3Rvci5leHRyYWN0X3ppcCh6aXBfcGF0aCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUHJvY2VzcyBtZXRhZGF0YSBmb3IgdGhpcyB6aXAKICAgICAgICAgICAgbWVkaWFfanNvbl9wYWlycyA9IHNlbGYuZXh0cmFjdG9yLmlkZW50aWZ5X21lZGlhX2pzb25fcGFpcnMoZXh0cmFjdGVkX2RpcikKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJGb3VuZCB7bGVuKG1lZGlhX2pzb25fcGFpcnMpfSBtZWRpYSBmaWxlcyBpbiB0aGlzIHppcCIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgbWVkaWFfanNvbl9wYWlyczoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTm8gbWVkaWEgZmlsZXMgZm91bmQgaW4ge3ppcF9wYXRoLm5hbWV9LCBza2lwcGluZyIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBNZXJnZSBtZXRhZGF0YQogICAgICAgICAgICBwcm9jZXNzZWRfZGlyID0gc2VsZi5iYXNlX2RpciAvIHNlbGYuY29uZmlnWydwcm9jZXNzaW5nJ11bJ3Byb2Nlc3NlZF9kaXInXQogICAgICAgICAgICBwcm9jZXNzZWRfZGlyLm1rZGlyKHBhcmVudHM9VHJ1ZSwgZXhpc3Rfb2s9VHJ1ZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUHJvY2VzcyBtZXRhZGF0YSBpbiBiYXRjaGVzCiAgICAgICAgICAgIGJhdGNoX3NpemUgPSBzZWxmLmNvbmZpZ1sncHJvY2Vzc2luZyddWydiYXRjaF9zaXplJ10KICAgICAgICAgICAgYWxsX2ZpbGVzID0gbGlzdChtZWRpYV9qc29uX3BhaXJzLmtleXMoKSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciBpIGluIHJhbmdlKDAsIGxlbihhbGxfZmlsZXMpLCBiYXRjaF9zaXplKToKICAgICAgICAgICAgICAgIGJhdGNoID0gYWxsX2ZpbGVzW2k6aSArIGJhdGNoX3NpemVdCiAgICAgICAgICAgICAgICBiYXRjaF9wYWlycyA9IHtmOiBtZWRpYV9qc29uX3BhaXJzW2ZdIGZvciBmIGluIGJhdGNofQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJQcm9jZXNzaW5nIG1ldGFkYXRhIGJhdGNoIHtpIC8vIGJhdGNoX3NpemUgKyAxfS97KGxlbihhbGxfZmlsZXMpICsgYmF0Y2hfc2l6ZSAtIDEpIC8vIGJhdGNoX3NpemV9IikKICAgICAgICAgICAgICAgIHNlbGYubWV0YWRhdGFfbWVyZ2VyLm1lcmdlX2FsbF9tZXRhZGF0YShiYXRjaF9wYWlycywgb3V0cHV0X2Rpcj1wcm9jZXNzZWRfZGlyKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBQYXJzZSBhbGJ1bXMgZm9yIHRoaXMgemlwCiAgICAgICAgICAgIHBhcnNlciA9IEFsYnVtUGFyc2VyKCkKICAgICAgICAgICAgcGFyc2VyLnBhcnNlX2Zyb21fZGlyZWN0b3J5X3N0cnVjdHVyZShleHRyYWN0ZWRfZGlyKQogICAgICAgICAgICBwYXJzZXIucGFyc2VfZnJvbV9qc29uX21ldGFkYXRhKG1lZGlhX2pzb25fcGFpcnMpCiAgICAgICAgICAgIGFsYnVtcyA9IHBhcnNlci5nZXRfYWxsX2FsYnVtcygpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFVwbG9hZCBmaWxlcyBmcm9tIHRoaXMgemlwCiAgICAgICAgICAgIGlmIHNlbGYuaWNsb3VkX3VwbG9hZGVyIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBzZWxmLnNldHVwX2ljbG91ZF91cGxvYWRlcih1c2Vfc3luY19tZXRob2Q9dXNlX3N5bmNfbWV0aG9kKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCdWlsZCBmaWxlLXRvLWFsYnVtIG1hcHBpbmcKICAgICAgICAgICAgZmlsZV90b19hbGJ1bSA9IHt9CiAgICAgICAgICAgIGZvciBhbGJ1bV9uYW1lLCBmaWxlcyBpbiBhbGJ1bXMuaXRlbXMoKToKICAgICAgICAgICAgICAgIGZvciBmaWxlX3BhdGggaW4gZmlsZXM6CiAgICAgICAgICAgICAgICAgICAgZmlsZV90b19hbGJ1bVtmaWxlX3BhdGhdID0gYWxidW1fbmFtZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBHZXQgcHJvY2Vzc2VkIGZpbGVzCiAgICAgICAgICAgIHByb2Nlc3NlZF9maWxlcyA9IFtdCiAgICAgICAgICAgIGZvciBtZWRpYV9maWxlIGluIG1lZGlhX2pzb25fcGFpcnMua2V5cygpOgogICAgICAgICAgICAgICAgcHJvY2Vzc2VkX2ZpbGUgPSBwcm9jZXNzZWRfZGlyIC8gbWVkaWFfZmlsZS5uYW1lCiAgICAgICAgICAgICAgICBpZiBwcm9jZXNzZWRfZmlsZS5leGlzdHMoKToKICAgICAgICAgICAgICAgICAgICBwcm9jZXNzZWRfZmlsZXMuYXBwZW5kKHByb2Nlc3NlZF9maWxlKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBwcm9jZXNzZWRfZmlsZXMuYXBwZW5kKG1lZGlhX2ZpbGUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFVwbG9hZAogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHNlbGYuaWNsb3VkX3VwbG9hZGVyLCBpQ2xvdWRQaG90b3NTeW5jVXBsb2FkZXIpOgogICAgICAgICAgICAgICAgdXBsb2FkX3Jlc3VsdHMgPSBzZWxmLmljbG91ZF91cGxvYWRlci51cGxvYWRfZmlsZXNfYmF0Y2goCiAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc2VkX2ZpbGVzLAogICAgICAgICAgICAgICAgICAgIGFsYnVtcz1maWxlX3RvX2FsYnVtCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIEdyb3VwIGJ5IGFsYnVtCiAgICAgICAgICAgICAgICB1cGxvYWRfcmVzdWx0cyA9IHt9CiAgICAgICAgICAgICAgICBmb3IgYWxidW1fbmFtZSwgZmlsZXMgaW4gYWxidW1zLml0ZW1zKCk6CiAgICAgICAgICAgICAgICAgICAgIyBNYXAgdG8gcHJvY2Vzc2VkIGZpbGVzCiAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc2VkX2FsYnVtX2ZpbGVzID0gW2YgZm9yIGYgaW4gcHJvY2Vzc2VkX2ZpbGVzIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgZmlsZV90b19hbGJ1bS5nZXQoZiwgJycpID09IGFsYnVtX25hbWVdCiAgICAgICAgICAgICAgICAgICAgaWYgcHJvY2Vzc2VkX2FsYnVtX2ZpbGVzOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlVwbG9hZGluZyBhbGJ1bToge2FsYnVtX25hbWV9ICh7bGVuKHByb2Nlc3NlZF9hbGJ1bV9maWxlcyl9IGZpbGVzKSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGFsYnVtX3Jlc3VsdHMgPSBzZWxmLmljbG91ZF91cGxvYWRlci51cGxvYWRfcGhvdG9zX2JhdGNoKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc2VkX2FsYnVtX2ZpbGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxidW1fbmFtZT1hbGJ1bV9uYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgdXBsb2FkX3Jlc3VsdHMudXBkYXRlKGFsYnVtX3Jlc3VsdHMpCiAgICAgICAgICAgIAogICAgICAgICAgICBzdWNjZXNzZnVsID0gc3VtKDEgZm9yIHYgaW4gdXBsb2FkX3Jlc3VsdHMudmFsdWVzKCkgaWYgdikKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJVcGxvYWRlZCB7c3VjY2Vzc2Z1bH0ve2xlbih1cGxvYWRfcmVzdWx0cyl9IGZpbGVzIGZyb20ge3ppcF9wYXRoLm5hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2xlYW51cCBleHRyYWN0ZWQgZmlsZXMgZm9yIHRoaXMgemlwIChzYXZlIGRpc2sgc3BhY2UpCiAgICAgICAgICAgIGltcG9ydCBzaHV0aWwKICAgICAgICAgICAgaWYgZXh0cmFjdGVkX2Rpci5leGlzdHMoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ2xlYW5pbmcgdXAgZXh0cmFjdGVkIGZpbGVzIGZvciB7emlwX3BhdGgubmFtZX0iKQogICAgICAgICAgICAgICAgc2h1dGlsLnJtdHJlZShleHRyYWN0ZWRfZGlyKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLinJMgQ2xlYW5lZCB1cCBleHRyYWN0ZWQgZmlsZXMgZm9yIHt6aXBfcGF0aC5uYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIuKckyBDb21wbGV0ZWQgcHJvY2Vzc2luZyB7emlwX3BhdGgubmFtZX0iKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkZhaWxlZCB0byBwcm9jZXNzIHt6aXBfcGF0aC5uYW1lfToge2V9IiwgZXhjX2luZm89VHJ1ZSkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfZmluZF9leGlzdGluZ196aXBzKHNlbGYsIHppcF9kaXI6IFBhdGgsIHppcF9maWxlX2xpc3Q6IExpc3RbZGljdF0pIC0+IExpc3RbUGF0aF06CiAgICAgICAgIiIiCiAgICAgICAgRmluZCB6aXAgZmlsZXMgdGhhdCBhcmUgYWxyZWFkeSBkb3dubG9hZGVkIGxvY2FsbHkuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgemlwX2RpcjogRGlyZWN0b3J5IGNvbnRhaW5pbmcgemlwIGZpbGVzCiAgICAgICAgICAgIHppcF9maWxlX2xpc3Q6IExpc3Qgb2YgemlwIGZpbGUgbWV0YWRhdGEgZnJvbSBHb29nbGUgRHJpdmUKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0IG9mIHBhdGhzIHRvIGV4aXN0aW5nIHppcCBmaWxlcwogICAgICAgICIiIgogICAgICAgIGV4aXN0aW5nX3ppcHMgPSBbXQogICAgICAgIHppcF9kaXIubWtkaXIocGFyZW50cz1UcnVlLCBleGlzdF9vaz1UcnVlKQogICAgICAgIAogICAgICAgICMgQ3JlYXRlIGEgc2V0IG9mIGV4cGVjdGVkIHppcCBmaWxlIG5hbWVzIGZvciBxdWljayBsb29rdXAKICAgICAgICBleHBlY3RlZF9uYW1lcyA9IHtmaWxlX2luZm9bJ25hbWUnXSBmb3IgZmlsZV9pbmZvIGluIHppcF9maWxlX2xpc3R9CiAgICAgICAgCiAgICAgICAgIyBGaW5kIG1hdGNoaW5nIHppcCBmaWxlcyBpbiB0aGUgZGlyZWN0b3J5CiAgICAgICAgZm9yIHppcF9maWxlIGluIHppcF9kaXIuZ2xvYigiKi56aXAiKToKICAgICAgICAgICAgaWYgemlwX2ZpbGUubmFtZSBpbiBleHBlY3RlZF9uYW1lczoKICAgICAgICAgICAgICAgIGV4aXN0aW5nX3ppcHMuYXBwZW5kKHppcF9maWxlKQogICAgICAgIAogICAgICAgIHJldHVybiBzb3J0ZWQoZXhpc3RpbmdfemlwcykgICMgU29ydCBmb3IgY29uc2lzdGVudCBwcm9jZXNzaW5nIG9yZGVyCiAgICAKICAgIGRlZiBydW4oc2VsZiwgdXNlX3N5bmNfbWV0aG9kOiBib29sID0gRmFsc2UpOgogICAgICAgICIiIlJ1biB0aGUgY29tcGxldGUgbWlncmF0aW9uIHByb2Nlc3MuIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFBoYXNlIDE6IExpc3QgYWxsIHppcCBmaWxlcyAod2l0aG91dCBkb3dubG9hZGluZyB5ZXQpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCI9IiAqIDYwKQogICAgICAgICAgICBsb2dnZXIuaW5mbygiUGhhc2UgMTogTGlzdGluZyB6aXAgZmlsZXMgZnJvbSBHb29nbGUgRHJpdmUiKQogICAgICAgICAgICBsb2dnZXIuaW5mbygiPSIgKiA2MCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGRyaXZlX2NvbmZpZyA9IHNlbGYuY29uZmlnWydnb29nbGVfZHJpdmUnXQogICAgICAgICAgICB6aXBfZGlyID0gc2VsZi5iYXNlX2RpciAvIHNlbGYuY29uZmlnWydwcm9jZXNzaW5nJ11bJ3ppcF9kaXInXQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMaXN0IGZpbGVzIHdpdGhvdXQgZG93bmxvYWRpbmcKICAgICAgICAgICAgemlwX2ZpbGVfbGlzdCA9IHNlbGYuZG93bmxvYWRlci5saXN0X3ppcF9maWxlcygKICAgICAgICAgICAgICAgIGZvbGRlcl9pZD1kcml2ZV9jb25maWcuZ2V0KCdmb2xkZXJfaWQnKSBvciBOb25lLAogICAgICAgICAgICAgICAgcGF0dGVybj1kcml2ZV9jb25maWcuZ2V0KCd6aXBfZmlsZV9wYXR0ZXJuJykgb3IgTm9uZQogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgemlwX2ZpbGVfbGlzdDoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiTm8gemlwIGZpbGVzIGZvdW5kLiBFeGl0aW5nLiIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2hlY2sgZm9yIGFscmVhZHktZG93bmxvYWRlZCB6aXAgZmlsZXMKICAgICAgICAgICAgZXhpc3RpbmdfemlwcyA9IHNlbGYuX2ZpbmRfZXhpc3Rpbmdfemlwcyh6aXBfZGlyLCB6aXBfZmlsZV9saXN0KQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgZXhpc3RpbmdfemlwczoKICAgICAgICAgICAgICAgIHRvdGFsX3NpemVfZ2IgPSBzdW0oZi5zdGF0KCkuc3Rfc2l6ZSBmb3IgZiBpbiBleGlzdGluZ196aXBzKSAvICgxMDI0ICoqIDMpCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiIikKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCI9IiAqIDYwKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJGb3VuZCB7bGVuKGV4aXN0aW5nX3ppcHMpfSBhbHJlYWR5LWRvd25sb2FkZWQgemlwIGZpbGVzICh7dG90YWxfc2l6ZV9nYjouMmZ9IEdCKSIpCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiVGhlc2Ugd2lsbCBiZSBwcm9jZXNzZWQgRklSU1QgdG8gZnJlZSB1cCBkaXNrIHNwYWNlIikKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCI9IiAqIDYwKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIiIpCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkZvdW5kIHtsZW4oemlwX2ZpbGVfbGlzdCl9IHppcCBmaWxlcyB0b3RhbCB0byBwcm9jZXNzIikKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIiIpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJQcm9jZXNzaW5nIGVhY2ggemlwIGZpbGUgaW5kaXZpZHVhbGx5OiIpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCIgIC0gRG93bmxvYWQg4oaSIEV4dHJhY3Qg4oaSIFByb2Nlc3MgbWV0YWRhdGEg4oaSIFVwbG9hZCDihpIgQ2xlYW51cCIpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCIgIChUaGlzIGFwcHJvYWNoIG1pbmltaXplcyBkaXNrIHNwYWNlIHVzYWdlKSIpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCIiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBTZXR1cCBpQ2xvdWQgdXBsb2FkZXIgb25jZSAoYmVmb3JlIHByb2Nlc3NpbmcgemlwcykKICAgICAgICAgICAgc2VsZi5zZXR1cF9pY2xvdWRfdXBsb2FkZXIodXNlX3N5bmNfbWV0aG9kPXVzZV9zeW5jX21ldGhvZCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHN1Y2Nlc3NmdWwgPSAwCiAgICAgICAgICAgIGZhaWxlZCA9IDAKICAgICAgICAgICAgdG90YWxfemlwcyA9IGxlbih6aXBfZmlsZV9saXN0KQogICAgICAgICAgICBwcm9jZXNzZWRfY291bnQgPSAwCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEZJUlNUOiBQcm9jZXNzIGFscmVhZHktZG93bmxvYWRlZCB6aXAgZmlsZXMgdG8gZnJlZSB1cCBzcGFjZQogICAgICAgICAgICBmb3IgZXhpc3RpbmdfemlwIGluIGV4aXN0aW5nX3ppcHM6CiAgICAgICAgICAgICAgICBwcm9jZXNzZWRfY291bnQgKz0gMQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCI9IiAqIDYwKQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUHJvY2Vzc2luZyBleGlzdGluZyB6aXAge3Byb2Nlc3NlZF9jb3VudH0ve3RvdGFsX3ppcHN9OiB7ZXhpc3RpbmdfemlwLm5hbWV9IikKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiPSIgKiA2MCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFByb2Nlc3MgdGhpcyB6aXAgZmlsZQogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYucHJvY2Vzc19zaW5nbGVfemlwKGV4aXN0aW5nX3ppcCwgcHJvY2Vzc2VkX2NvdW50LCB0b3RhbF96aXBzLCB1c2Vfc3luY19tZXRob2QpOgogICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzZnVsICs9IDEKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgQ2xlYW51cCB6aXAgZmlsZSBhZnRlciBzdWNjZXNzZnVsIHByb2Nlc3NpbmcgdG8gZnJlZSB1cCBzcGFjZQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkRlbGV0aW5nIHppcCBmaWxlIHRvIGZyZWUgdXAgZGlzayBzcGFjZToge2V4aXN0aW5nX3ppcC5uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nX3ppcC51bmxpbmsoKQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIuKckyBEZWxldGVkIHtleGlzdGluZ196aXAubmFtZX0iKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZCArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiRmFpbGVkIHRvIHByb2Nlc3Mge2V4aXN0aW5nX3ppcC5uYW1lfSwga2VlcGluZyB6aXAgZmlsZSBmb3IgcmV0cnkiKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBmYWlsZWQgKz0gMQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkVycm9yIHByb2Nlc3Npbmcge2V4aXN0aW5nX3ppcC5uYW1lfToge2V9IiwgZXhjX2luZm89VHJ1ZSkKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlNraXBwaW5nIHJlbWFpbmluZyBwcm9jZXNzaW5nIGZvciB7ZXhpc3RpbmdfemlwLm5hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVEhFTjogRG93bmxvYWQgYW5kIHByb2Nlc3MgcmVtYWluaW5nIHppcCBmaWxlcwogICAgICAgICAgICBmb3IgZmlsZV9pbmZvIGluIHppcF9maWxlX2xpc3Q6CiAgICAgICAgICAgICAgICB6aXBfZmlsZV9wYXRoID0gemlwX2RpciAvIGZpbGVfaW5mb1snbmFtZSddCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgU2tpcCBpZiB3ZSBhbHJlYWR5IHByb2Nlc3NlZCB0aGlzIGZpbGUgKG9yIGl0IGZhaWxlZCkKICAgICAgICAgICAgICAgIGlmIHppcF9maWxlX3BhdGguZXhpc3RzKCk6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcHJvY2Vzc2VkX2NvdW50ICs9IDEKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAjIERvd25sb2FkIHRoaXMgemlwIGZpbGUKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiPSIgKiA2MCkKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkRvd25sb2FkaW5nIHppcCB7cHJvY2Vzc2VkX2NvdW50fS97dG90YWxfemlwc306IHtmaWxlX2luZm9bJ25hbWUnXX0iKQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCI9IiAqIDYwKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHppcF9maWxlID0gc2VsZi5kb3dubG9hZGVyLmRvd25sb2FkX3NpbmdsZV96aXAoZmlsZV9pbmZvLCB6aXBfZGlyKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgUHJvY2VzcyB0aGlzIHppcCBmaWxlCiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5wcm9jZXNzX3NpbmdsZV96aXAoemlwX2ZpbGUsIHByb2Nlc3NlZF9jb3VudCwgdG90YWxfemlwcywgdXNlX3N5bmNfbWV0aG9kKToKICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2Vzc2Z1bCArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIENsZWFudXAgemlwIGZpbGUgYWZ0ZXIgc3VjY2Vzc2Z1bCBwcm9jZXNzaW5nIHRvIGZyZWUgdXAgc3BhY2UKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJEZWxldGluZyB6aXAgZmlsZSB0byBmcmVlIHVwIGRpc2sgc3BhY2U6IHt6aXBfZmlsZS5uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHppcF9maWxlLnVubGluaygpCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi4pyTIERlbGV0ZWQge3ppcF9maWxlLm5hbWV9IikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQgKz0gMQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkZhaWxlZCB0byBwcm9jZXNzIHt6aXBfZmlsZS5uYW1lfSwga2VlcGluZyB6aXAgZmlsZSBmb3IgcmV0cnkiKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBmYWlsZWQgKz0gMQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkVycm9yIHByb2Nlc3Npbmcge2ZpbGVfaW5mby5nZXQoJ25hbWUnLCAndW5rbm93bicpfToge2V9IiwgZXhjX2luZm89VHJ1ZSkKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlNraXBwaW5nIHJlbWFpbmluZyBwcm9jZXNzaW5nIGZvciB7ZmlsZV9pbmZvLmdldCgnbmFtZScsICd1bmtub3duJyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgRmluYWwgY2xlYW51cAogICAgICAgICAgICBpZiBzZWxmLmNvbmZpZ1sncHJvY2Vzc2luZyddLmdldCgnY2xlYW51cF9hZnRlcl91cGxvYWQnLCBGYWxzZSk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiPSIgKiA2MCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJGaW5hbCBjbGVhbnVwIikKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCI9IiAqIDYwKQogICAgICAgICAgICAgICAgcHJvY2Vzc2VkX2RpciA9IHNlbGYuYmFzZV9kaXIgLyBzZWxmLmNvbmZpZ1sncHJvY2Vzc2luZyddWydwcm9jZXNzZWRfZGlyJ10KICAgICAgICAgICAgICAgIGlmIHByb2Nlc3NlZF9kaXIuZXhpc3RzKCk6CiAgICAgICAgICAgICAgICAgICAgaW1wb3J0IHNodXRpbAogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUmVtb3ZpbmcgcHJvY2Vzc2VkIGZpbGVzOiB7cHJvY2Vzc2VkX2Rpcn0iKQogICAgICAgICAgICAgICAgICAgIHNodXRpbC5ybXRyZWUocHJvY2Vzc2VkX2RpcikKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCI9IiAqIDYwKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk1pZ3JhdGlvbiBjb21wbGV0ZWQhIikKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiIgIFN1Y2Nlc3NmdWw6IHtzdWNjZXNzZnVsfS97bGVuKHppcF9maWxlX2xpc3QpfSB6aXAgZmlsZXMiKQogICAgICAgICAgICBpZiBmYWlsZWQgPiAwOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiIgIEZhaWxlZDoge2ZhaWxlZH0ve2xlbih6aXBfZmlsZV9saXN0KX0gemlwIGZpbGVzIikKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIj0iICogNjApCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTWlncmF0aW9uIGZhaWxlZDoge2V9IiwgZXhjX2luZm89VHJ1ZSkKICAgICAgICAgICAgcmFpc2UKCgpkZWYgbWFpbigpOgogICAgIiIiTWFpbiBlbnRyeSBwb2ludC4iIiIKICAgIHBhcnNlciA9IGFyZ3BhcnNlLkFyZ3VtZW50UGFyc2VyKAogICAgICAgIGRlc2NyaXB0aW9uPSdNaWdyYXRlIEdvb2dsZSBQaG90b3MgdG8gaUNsb3VkIFBob3RvcycKICAgICkKICAgIHBhcnNlci5hZGRfYXJndW1lbnQoCiAgICAgICAgJy0tY29uZmlnJywKICAgICAgICB0eXBlPXN0ciwKICAgICAgICBkZWZhdWx0PSdjb25maWcueWFtbCcsCiAgICAgICAgaGVscD0nUGF0aCB0byBjb25maWd1cmF0aW9uIGZpbGUgKGRlZmF1bHQ6IGNvbmZpZy55YW1sKScKICAgICkKICAgIHBhcnNlci5hZGRfYXJndW1lbnQoCiAgICAgICAgJy0tdXNlLXN5bmMnLAogICAgICAgIGFjdGlvbj0nc3RvcmVfdHJ1ZScsCiAgICAgICAgaGVscD0nVXNlIFBob3RvcyBsaWJyYXJ5IHN5bmMgbWV0aG9kIGluc3RlYWQgb2YgQVBJIHVwbG9hZCcKICAgICkKICAgIAogICAgYXJncyA9IHBhcnNlci5wYXJzZV9hcmdzKCkKICAgIAogICAgb3JjaGVzdHJhdG9yID0gTWlncmF0aW9uT3JjaGVzdHJhdG9yKGFyZ3MuY29uZmlnKQogICAgb3JjaGVzdHJhdG9yLnJ1bih1c2Vfc3luY19tZXRob2Q9YXJncy51c2Vfc3luYykKCgppZiBfX25hbWVfXyA9PSAnX19tYWluX18nOgogICAgbWFpbigpCgo="""

def main():
    print("=" * 60)
    print("Updating files on VM...")
    print("=" * 60)
    print()
    
    # Backup existing files
    for fname in ['drive_downloader.py', 'main.py']:
        file_path = Path(fname)
        if file_path.exists():
            backup_path = Path(fname + '.backup')
            backup_path.write_bytes(file_path.read_bytes())
            print(f"✓ Backed up {fname}")
        else:
            print(f"⚠ {fname} not found (will create new file)")
    
    print()
    
    # Decode and write updated files
    try:
        drive_content = base64.b64decode(DRIVE_B64)
        Path('drive_downloader.py').write_bytes(drive_content)
        print("✓ Updated drive_downloader.py")
        
        main_content = base64.b64decode(MAIN_B64)
        Path('main.py').write_bytes(main_content)
        print("✓ Updated main.py")
    except Exception as e:
        print(f"✗ Error updating files: {e}")
        sys.exit(1)
    
    print()
    print("=" * 60)
    print("✓ Files updated successfully!")
    print("=" * 60)
    print()
    print("Verify the updates:")
    print("  grep -n '_find_existing_zips' main.py")
    print("  grep -n '_check_disk_space' drive_downloader.py")
    print("  grep -n 'Phase 1: Listing zip files' main.py")
    print()
    print("Then run:")
    print("  python3 main.py --config config.yaml")
    print()

if __name__ == '__main__':
    main()
