{% extends "base.html" %}

{% block content %}
<h1>Migration Dashboard</h1>

<div id="setup-section">
    <div class="step">
        <h2>Configuration</h2>
        <label>Google Drive Folder ID (optional):</label>
        <input type="text" id="folder-id" placeholder="Leave empty to search all folders">
        <small>Find this in your Google Drive folder URL after /folders/</small>
        
        <label>Zip File Pattern:</label>
        <input type="text" id="zip-pattern" value="takeout-*.zip">
        <small>Pattern to match Google Takeout zip files</small>
        
        <button onclick="startMigration()">Start Migration</button>
    </div>
</div>

<div id="progress-section" style="display:none;">
    <div class="step">
        <h2 id="current-phase">Initializing...</h2>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width:0%;">0%</div>
        </div>
        <p>Status: <span id="status-text">Ready</span></p>
        <p>Files: <span id="files-text">0 / 0</span></p>
        
        <button onclick="stopMigration()" style="background:#ea4335;">Stop Migration</button>
    </div>
    
    <div class="status-log" id="status-log">
        Waiting to start...
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
let statusInterval = null;

function startMigration() {
    const folderId = document.getElementById('folder-id').value;
    const zipPattern = document.getElementById('zip-pattern').value;
    
    axios.post('/migration/start', {
        folder_id: folderId,
        zip_pattern: zipPattern
    })
    .then(response => {
        document.getElementById('setup-section').style.display = 'none';
        document.getElementById('progress-section').style.display = 'block';
        startPolling();
    })
    .catch(error => {
        alert('Error starting migration: ' + (error.response?.data?.error || error.message));
    });
}

function startPolling() {
    statusInterval = setInterval(pollStatus, 2000);
    pollStatus(); // Immediate first poll
}

function pollStatus() {
    axios.get('/status/current')
        .then(response => {
            updateProgress(response.data);
        })
        .catch(error => {
            console.error('Error polling status:', error);
        });
}

function updateProgress(data) {
    document.getElementById('current-phase').textContent = data.phase || 'Processing';
    document.getElementById('status-text').textContent = data.status || 'unknown';
    
    const progress = data.progress || 0;
    document.getElementById('progress-fill').style.width = progress + '%';
    document.getElementById('progress-fill').textContent = Math.round(progress) + '%';
    
    const filesText = `${data.processed_files || 0} / ${data.total_files || 0}`;
    document.getElementById('files-text').textContent = filesText;
    
    if (data.log && data.log.length > 0) {
        const logDiv = document.getElementById('status-log');
        const logEntry = data.log[data.log.length - 1];
        logDiv.innerHTML += '<div>' + logEntry + '</div>';
        logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    // Stop polling if completed or error
    if (data.status === 'completed' || data.status === 'error' || data.status === 'stopped') {
        if (statusInterval) {
            clearInterval(statusInterval);
            statusInterval = null;
        }
    }
}

function stopMigration() {
    if (confirm('Are you sure you want to stop the migration?')) {
        axios.post('/migration/stop')
            .then(() => {
                if (statusInterval) {
                    clearInterval(statusInterval);
                    statusInterval = null;
                }
                alert('Migration stopped');
            });
    }
}

// Check if migration is already running
window.onload = function() {
    pollStatus();
    const status = document.getElementById('status-text').textContent;
    if (status === 'running' || status === 'starting') {
        document.getElementById('setup-section').style.display = 'none';
        document.getElementById('progress-section').style.display = 'block';
        startPolling();
    }
};
</script>
{% endblock %}

